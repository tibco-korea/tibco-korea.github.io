---
sort: 6
---
# BWCE CI/CD 파이프라인 구성

[toc]

### 0. 환경 이해

BWCE의 CI/CD를 환경 구축을 위하여 본 블로그에서는 GitHub 와 Jenkins 환경을 이용하고자 합니다. 
기타 다른 형상관리툴과 배포 툴을 이용하더라도 근본적으로 Maven을 지원하는 환경하에서는 유사한 패턴을 가지기 때문에 GitHub와 Jenkins 환경의 CI/CD 환경에 대한 이해를 그대로 적용 하실수 있습니다.

### 1. Jenkins 환경 구축

본 블로그에서는 구축되어 있는 Kubernetes환경 하에서 Jenkins 환경을 Container환경으로 구축합니다.
BWCE의 CI/CD를 위해서는 Jenkins Container 내부에서 Docker Image를 Build 할수 있어야 합니다.

#### 1.1 Jenkins Pod Resource 생성

jenkins_pod.yaml 파일을 생성합니다.
```
apiVersion: v1
kind: Pod
metadata:
  name: jenkins-docker
  labels:
    app: jenkins-docker
    deployment: jenkins-docker
spec:
  containers:
    - name: jenkins-docker
      image: jenkins/jenkins:lts
      ports:
        - containerPort: 8080
          protocol: TCP
        - containerPort: 50000
          protocol: TCP
      env:
        - name: TZ
          value:  "Asia/Seoul"
      imagePullPolicy: Always
      securityContext:
        runAsUser: 0
      volumeMounts:
      - name: docker-sock
        mountPath: /var/run/docker.sock
  volumes:
  - name: docker-sock
    hostPath:
      path: /var/run/docker.sock
  restartPolicy: Always
```

> Jenkins Container가 생성되는 노드 호스트의 /var/run/docker.sock 를 Jenkins Container에 마운트 하여 Jenkins Container내부에서 Docker Image를 Build 할 수 있도록 합니다.
> /var/run/docker.sock 는 기본적으로 root 계정에서만 접근 가능하기 때문에 Jenkins Container의 계정을 runAsUser: 0 을 통해 root 계정으로 실행하도록 합니다. (또는 노드 호스트의 /var/run/docker.sock의 퍼미션을 666으로 변경하여 다른 계정에서 접근 하도록 변경하여도 됩니다.)



Jenkins Pod를 생성합니다.

```bash
$ kubectl create -f  jenkins_pod.yaml
pod/jenkins-docker created
```

#### 1.2.  Jenkins Service Resource 생성

jenkins_service.yaml 파일을 생성합니다.
```
apiVersion: v1
kind: Service
metadata:
  name: jenkins-docker-service
spec:
  type: NodePort
  selector:
    deployment: jenkins-docker
  ports:
  - port: 8080
    protocol: TCP
    targetPort: 8080
    nodePort: 32088
```
> nodePort 는 32088로 설정하였으며, 해당 port로 웹 접근 가능합니다.

Jenkins Service를 생성합니다.
```bash
$ kubectl create -f  jenkins_pod.yam
service/jenkins-docker-service created
```

#### 1.3.  Jenkins 접속 및 초기화

URL : http://{Worker-node-IP}:32088/ 로 접속

<img src ="./img/jenkins_init1.png" width=800  >


Jenkins Pod에 cat /var/jenkins_home/secrets/initialAdminPassword 명령어를 전달하여 Admin Password 얻기


```bash
$ kubectl exec -it  jenkins-docker cat /var/jenkins_home/secrets/initialAdminPassword
363bba765abb43b0aa5651279973dafc
```

기본 추천 plugin 셋 설치하기

<img src ="./img/jenkins_init2.png" width=800  >

<img src ="./img/jenkins_init3.png" width=800>

기본 사용자 추가

<img src ="./img/jenkins_init4.png" width=500  >

#### 1.4.  Jenkins 에 Maven 설정

Dashboard -> Manage Jenkins -> Global Tool Configuration 항목 들어가기
![jenkins_maven](./img/jenkins_init5.png)

Maven 항목에서 Maven 최신 버전을 자동 설치 
![jenkins_maven](./img/jenkins_init6.png)
> Maven Name은 버젼별로 Jenkins Job 혹은 pipeline에서 호출될 이름입니다. 블로그에서는 Maven3로 명명 하였습니다.

#### 1.5. Jenkins Blue Ocean plugin 설정

Dashboard -> Manage Jenkins -> Manage Plugins 항목 들어가기
![jenkins_maven](./img/jenkins_init7.png)

Available 항목에서 Blue Ocean 검색 및 설치
![jenkins_maven](./img/jenkins_init8.png)

Blue Ocean Plugin과 디펜던시를 가지는 연관 Plugin 자동 설치

<img src ="./img/jenkins_init9.png" width=800  >



### 2. GitHub에 Provider Application용 리파지터리 생성

각 Application(Provicer와 Consumer) 별로 독자적인 개발 라이프사이클을 위해서 독자적인 Git 리파지터리를 생성합니다.

Github 웹으로 로그인
Github -> New repository 클릭
![Github_1](./img/Github_1.png)

repository 이름을 Provider_CICD로 생성

<img src ="./img/Github_2.png" width=800  >

생성된 repository의 URL을 복사합니다. (https://github.com/chungsju/Provider_CICD.git)

<img src ="./img/Github_3.png" width=800  >



### 3. Provider Application을 Git 리파지터리에 공유

#### 3.1 BusinessStudio에 Git 리파지터리 등록

BusinessStudio -> Windows -> Open Perspective -> Other 선택

<img src ="./img/bw_git1.png" width=500  >

Git Perspective 선택

<img src ="./img/bw_git2.png" width=500  >

GitHub의 리파지터리를 Local로 Clone하기

<img src ="./img/bw_git3.png" width=500  >

<img src ="./img/bw_git4.png" width=800  >

Provider Application을 Git 리파지터리로 공유

<img src ="./img/bw_git5.png" width=500  >
<img src ="./img/bw_git6.png" width=800  >
<img src ="./img/bw_git7.png" width=800  >

Provider Application 프로젝트 파일을 Commit & Push 하여 Git 리파지터리로 업로드

<img src ="./img/bw_git8.png" width=500  >
<img src ="./img/bw_git9.png" width=500  >



#### 3.1 상대경로 설정
#### 3.2 setting.xml 생성
#### 3.3 jenkins 파일 생성
#### 3.4 commit & push



### 5. Jenkins Pipeline 빌드

### 6. web hook 설정



